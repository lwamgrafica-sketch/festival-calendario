<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<title>Eventi (iframe)</title>
<style>
  html,body{height:100%; margin:0; font-family: sans-serif;}
  section.day{min-height:100vh; padding:30px; border-bottom:1px solid #ddd;}
  section.day h3{margin:0 0 12px;}
</style>
</head>
<body>
  <section class="day" data-date="10 settembre 2025"><h3>10 settembre 2025</h3><p>Evento X</p></section>
  <section class="day" data-date="12 settembre 2025"><h3>12 settembre 2025</h3><p>Evento Y</p></section>
  <section class="day" data-date="15 settembre 2025"><h3>15 settembre 2025</h3><p>Evento Z</p></section>
  <section class="day" data-date="18 settembre 2025"><h3>18 settembre 2025</h3><p>Evento A</p></section>
  <section class="day" data-date="20 settembre 2025"><h3>20 settembre 2025</h3><p>Evento B</p></section>

<script>
(function(){
  'use strict';
  const secs = Array.from(document.querySelectorAll('section.day'));

  // funzione di parse semplice (accetta "DD mese YYYY")
  function parseDate(s){
    if(!s) return null;
    const m = s.trim().match(/(\d{1,2})\s+([^\d]+?)\s+(\d{4})/);
    if(!m) return null;
    const day = parseInt(m[1],10);
    const monthStr = m[2].toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const year = parseInt(m[3],10);
    const months = { 'gennaio':0,'febbraio':1,'marzo':2,'aprile':3,'maggio':4,'giugno':5,'luglio':6,'agosto':7,'settembre':8,'ottobre':9,'novembre':10,'dicembre':11,
                     'january':0,'february':1,'march':2,'april':3,'may':4,'june':5,'july':6,'august':7,'september':8,'october':9,'november':10,'december':11,
                     'janvier':0,'fevrier':1,'mars':2,'avril':3,'mai':4,'juin':5,'juillet':6,'aout':7,'septembre':8,'octobre':9,'novembre':10,'decembre':11 };
    const mon = months[monthStr] !== undefined ? months[monthStr] : null;
    if(mon===null) return null;
    const d = new Date(year, mon, day); d.setHours(0,0,0,0);
    return d;
  }

  // trova primo evento >= oggi, altrimenti primo evento
  function findTarget(){
    const now = new Date(); now.setHours(0,0,0,0);
    for(const s of secs){
      const d = parseDate(s.dataset.date || s.querySelector('h3')?.textContent);
      if(d && d >= now) return s;
    }
    return secs[0] || null;
  }

  // notifica parent della data corrente visibile
  function notifyParent(dateText){
    // usa postMessage (targetOrigin '*' per test; poi sostituisci con l'origine del sito se vuoi sicurezza)
    window.parent.postMessage({ type: 'dateChange', date: dateText }, '*');
  }

  // aggiorna la data corrente basandoci su quale sezione è in vista dentro l'iframe
  function updateOnScroll(){
    let current = secs[0];
    const threshold = window.innerHeight * 0.15; // usare un piccolo offset
    for(const s of secs){
      const r = s.getBoundingClientRect();
      if(r.top <= threshold) current = s;
      else break;
    }
    notifyParent(current.dataset.date || current.querySelector('h3')?.textContent || '—');
  }

  document.addEventListener('scroll', () => { requestAnimationFrame(updateOnScroll); }, { passive:true });

  // all'apertura: scrolla al target interno dell'iframe
  window.addEventListener('DOMContentLoaded', () => {
    const target = findTarget();
    if(target){
      // scrolla l'iframe internamente
      target.scrollIntoView({ behavior: 'auto', block: 'start' });
    }
    // invia subito la data iniziale
    setTimeout(updateOnScroll, 50);
  });
})();
</script>
</body>
</html>
